# Assignment2
In this assignment I built on-top of the cloud-based components developed in the first assignment. I replaced the virtual environmental stations developed using Java with new ones built using the *RIOT-OS* and MQTT-SN protocol. I used the native emulator of *RIOT-OS* to run the stations and generate values over MQTT-SN that need to arrive to the cloud via the MQTT. I also used IOT-LAB to execute the *RIOT-OS* application on real devices.

# Virtual Sensors
Using *RIOT-OS* I developed an application that represents a virtual environmental station that generates periodically a set of random values for 5 different sensors:

- temperature (-50 ... 50 Celsius)
- humidity (0 ... 100%)
- wind direction (0 ... 360 degrees)
- wind intensity (0 ... 100 m/s)
- rain height (0 ... 50 mm / h)

The virtual environmental station uses a unique ID (identity) to publish these random values on an MQTT-SN channel, so you can start several instances
running using the native emulator of *RIOT-OS* and publishing their values on the MQTT-SN channel.

#MQTT-SN broker
I setup a RSMB where the *RIOT-OS* applications publish their values over UDP/IPv6. The Really Small Message Broker is a server implementation of the MQTT and MQTT-SN protocols over Mosquitto. Any client that implements this protocol properly can use this server for sending and receiving messages.

#MQTT-SN/MQTT transparent bridge
Using *Python* language programming I developed an MQTT-SN/MQTT transparent bridge. The goal of the bridge is to subscribe to a predefined set of topics on the MQTT-SN broker (e.g., RSMB) and forward all messages received to the same topic on the MQTT broker that is controlled by the cloud-based backend (i.e., publish them). I use the MQTT broker configured during the previous assignment via *AWS IoT*.

The values generated by the emulated *RIOT-OS* application developed in the previous steps are visible through the [websites](https://666thenumberofthebeast.github.io/InternetOfThings19-20/) developed in the previous assignment.

#Testbed deployment
Using *IOT-LAB* you need to deploy your *RIOT-OS* application on at least two nodes:
- Replace your code so that the values are not generated randomly but instead are connected to the real hardware sensors provided by the testbed infrastructure.
- Make sure you properly setup your network so that the MQTT-SN broker and MQTT-SN/MQTT transparent forwarded properly connect and forward the packets received from the IPv6 sensor network to the cloud.

# Extra
[Demo](https://youtu.be/Bl5EqkK0KrA) of the system.
[Blog Post](https://www.hackster.io/xmetal1997/iot-virtual-environment-stations-emulator-4fc78b) where you can find a hands-on tutorial on how to setup and run the system.

***
Â© All rights reserved, 666TheNumberOfTheBeast








WHAT/HOW TO SUBMIT
Create a YouTube video with a 3 minute demonstration of your system.
Create a Blog Post where you present a hands-on tutorial on how to setup and run your system, first using the native emulator and then using the IoT-Lab facility.
Extend the GitHub repository of the previous assignment to push all your code and scripts that are need to realize the above assignment.
Make sure that you re-organize your repository so that the code used in the previous assignment along with the new code are properly structured and interoperable. The website should be able to receive value via the cloud-based infrastructure either from a set of virtual stations using MQTT, or via RIOT-OS emulated stations using MQTT-SN or via real hardware deployed on the real-world testbed.
Update the README.md file where you provide links to your video and post of the new assignment, and also those of the previous one in a structured way.




## About
This application demonstrates the usage of the emCute (MQTT-SN) module in RIOT.

## Setup
For using this example, two prerequisites have to be fulfilled:

1. You need a running MQTT broker that supports MQTT-SN or a running MQTT-SN
   gateway that is connected to a running MQTT broker
2. Your RIOT node needs to be able to speak to that broker/gateway


### Setting up a broker
In general, any MQTT-SN capable broker or broker/gateway setup will do.
Following a quick instruction on how-to setup the Mosquitto Real Simple Message
Broker:

1. Get the RSMB here: https://github.com/eclipse/mosquitto.rsmb
```
git clone https://github.com/eclipse/mosquitto.rsmb.git
```

2. Go into the source folder and build the RSMB
```
cd mosquitto.rsmb/rsmb/src
make
```

3. Create a config file. In this case we run the RSMB as MQTT and MQTT-SN
   capable broker, using port 1885 for MQTT-SN and 1886 for MQTT and enabling
   IPv6, so save the following to `config.conf`:
```
# add some debug output
trace_output protocol

# listen for MQTT-SN traffic on UDP port 1885
listener 1885 INADDR_ANY mqtts
  ipv6 true

# listen to MQTT connections on tcp port 1886
listener 1886 INADDR_ANY
  ipv6 true
```

4. Start the broker:
```
./broker_mqtts config.conf
```

You can refer to
https://rawgit.com/MichalFoksa/rsmb/master/rsmb/doc/gettingstarted.htm for more
configuration options.


### Setting up RIOT `native`
When running this example under native, we must configure some global addresses,
as the RSMB doesn't seems to be able to handle link-local addresses. So for a
single RIOT native instance, we can do the following:

1. Setup `tap` and `tapbr` devices using RIOT's `tapsetup` script:
```
sudo ./RIOTDIR/dist/tools/tapsetup/tapsetup
```

2. Assign a site-global prefix to the `tapbr0` interface (the name could be
   different on OSX etc):
```
sudo ip a a fec0:affe::1/64 dev tapbr0
```

3. Assign a site-global address with the same prefix within the RIOT `native`
   instance (open first with `BOARD=native make term`):
```
ifconfig 5 add fec0:affe::99
```


## Usage
This example maps all available MQTT-SN functions to shell commands. Simply type
`help` to see the available commands. The most important steps are explained
below:

- To connect to a broker, use the `con` command:
```
con fec0:affe::1 1885
```

- To subscribe to a topic, run `sub` with the topic name as parameter, e.g.
```
sub hello/world
```

- For publishing, use the `pub` command:
```
pub hello/world "One more beer, please."
```

That's it, happy publishing!


## FAQ

### I can't connect multiple RIOT nodes to a broker, what can I do?
Each node that connects to the broker must have a unique node ID string set. Per
default, this example sets this statically ID to `gertrud`. If you want to
connect more than one node to the broker, you need to set a custom ID for each
node during compile time. Simply use the `EMCUTE_ID` environment variable for
this, e.g. build with `EMCUTE_ID=horst make all`.
